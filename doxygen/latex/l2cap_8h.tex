\doxysection{powerblocks/core/bluetooth/l2cap.h File Reference}
\hypertarget{l2cap_8h}{}\label{l2cap_8h}\index{powerblocks/core/bluetooth/l2cap.h@{powerblocks/core/bluetooth/l2cap.h}}


Bluetooth L2\+CAP Layer.  


{\ttfamily \#include $<$stdint.\+h$>$}\newline
{\ttfamily \#include "{}Free\+RTOS.\+h"{}}\newline
{\ttfamily \#include "{}semphr.\+h"{}}\newline
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
struct \mbox{\hyperlink{structl2cap__signal__t}{l2cap\+\_\+signal\+\_\+t}}
\item 
struct \mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}}
\item 
struct \mbox{\hyperlink{structl2cap__device__t}{l2cap\+\_\+device\+\_\+t}}
\end{DoxyCompactItemize}
\doxysubsubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{l2cap_8h_a8a2b35f6fe17e1aa4e9c7b5dbf250eab}\label{l2cap_8h_a8a2b35f6fe17e1aa4e9c7b5dbf250eab} 
\#define {\bfseries L2\+CAP\+\_\+\+SIGNAL\+\_\+\+CHANNEL\+\_\+\+BUFFER\+\_\+\+SIZE}~256
\item 
\Hypertarget{l2cap_8h_ab0021d9c02eeabe76ac2939a17ce1a3c}\label{l2cap_8h_ab0021d9c02eeabe76ac2939a17ce1a3c} 
\#define {\bfseries L2\+CAP\+\_\+\+CHANNEL\+\_\+\+SIGNALS}~0x0001
\item 
\Hypertarget{l2cap_8h_a181975ba88d51c67661b616a1444f0d4}\label{l2cap_8h_a181975ba88d51c67661b616a1444f0d4} 
\#define {\bfseries L2\+CAP\+\_\+\+DEFAULT\+\_\+\+MTU}~185
\item 
\Hypertarget{l2cap_8h_ad717de723a38875466c34b067dbc67bb}\label{l2cap_8h_ad717de723a38875466c34b067dbc67bb} 
\#define {\bfseries L2\+CAP\+\_\+\+DEFAULT\+\_\+\+FLUSH\+\_\+\+TIMEOUT}~0x\+FFFF
\end{DoxyCompactItemize}
\doxysubsubsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{l2cap_8h_adbe557a7757a997afba374b555de460c}\label{l2cap_8h_adbe557a7757a997afba374b555de460c} 
typedef void(\texorpdfstring{$\ast$}{*} {\bfseries l2cap\+\_\+channel\+\_\+event\+\_\+t}) (void \texorpdfstring{$\ast$}{*}channel, void \texorpdfstring{$\ast$}{*}user)
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \mbox{\hyperlink{l2cap_8h_a52ee42d4666663b934669a00485c1360}{l2cap\+\_\+initialize}} ()
\begin{DoxyCompactList}\small\item\em Initalized L2\+CAP. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{l2cap_8h_a8a81a732f492fd7f73db9c3e28cb1b38}{l2cap\+\_\+signal\+\_\+close}} ()
\begin{DoxyCompactList}\small\item\em Begins closing out of L2\+CAP. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{l2cap_8h_a3c8cff668e194b72f1bf772fdd26895d}{l2cap\+\_\+close}} ()
\begin{DoxyCompactList}\small\item\em Closes out of L2\+CAP. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{l2cap_8h_a0a485db9568ba82e42f1adffe8d37bab}{l2cap\+\_\+open\+\_\+device}} (\mbox{\hyperlink{structl2cap__device__t}{l2cap\+\_\+device\+\_\+t}} \texorpdfstring{$\ast$}{*}device\+\_\+handle, uint16\+\_\+t hci\+\_\+device\+\_\+handle, const uint8\+\_\+t \texorpdfstring{$\ast$}{*}mac\+\_\+address)
\begin{DoxyCompactList}\small\item\em Opens a L2\+CAP Connections. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{l2cap_8h_ad4c40ef4c55b21acb04949a4c6c062dd}{l2cap\+\_\+close\+\_\+device}} (\mbox{\hyperlink{structl2cap__device__t}{l2cap\+\_\+device\+\_\+t}} \texorpdfstring{$\ast$}{*}device\+\_\+handle)
\begin{DoxyCompactList}\small\item\em Closes a L2\+CAP Connection. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{l2cap_8h_ad1afe37de6799a07366fe423faeab045}{l2cap\+\_\+open\+\_\+channel}} (\mbox{\hyperlink{structl2cap__device__t}{l2cap\+\_\+device\+\_\+t}} \texorpdfstring{$\ast$}{*}device\+\_\+handle, \mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}channel, uint16\+\_\+t protocol\+\_\+id, uint8\+\_\+t \texorpdfstring{$\ast$}{*}rx\+\_\+buffer, int rx\+\_\+buffer\+\_\+size)
\begin{DoxyCompactList}\small\item\em Opens a L2\+CAP Channel. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{l2cap_8h_a6f48dd9f6644b829f23cae02cefad73d}{l2cap\+\_\+close\+\_\+channel}} (\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}channel)
\begin{DoxyCompactList}\small\item\em Closes a L2\+CAP Channel. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{l2cap_8h_a5bf23efd5d1b3891cebdadf972f89bb7}{l2cap\+\_\+send\+\_\+channel}} (\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}channel, const void \texorpdfstring{$\ast$}{*}data, uint16\+\_\+t size)
\begin{DoxyCompactList}\small\item\em Sends data over a L2\+CAP Channel. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{l2cap_8h_a8d95274e8365de6adde2b5e305feb540}{l2cap\+\_\+receive\+\_\+channel}} (\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}channel, void \texorpdfstring{$\ast$}{*}data, uint16\+\_\+t size)
\begin{DoxyCompactList}\small\item\em Receives from a L2\+CAP Channel. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{l2cap_8h_a4a876ed132e8c5ffc77f02842e405eeb}{l2cap\+\_\+set\+\_\+channel\+\_\+receive\+\_\+event}} (\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}channel, l2cap\+\_\+channel\+\_\+event\+\_\+t event, void \texorpdfstring{$\ast$}{*}param)
\begin{DoxyCompactList}\small\item\em Sets the L2\+CAP on packet receive event. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Bluetooth L2\+CAP Layer. 

L2\+CAP is a higher level ontop of HCI\textquotesingle{}s ACI packets used to send and receive data from devices.

Its in charge of multiplexing data and reassembling/disassembling packets.

\begin{DoxyAuthor}{Author}
Samuel Fitzsimons (rainbain) 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
2025 
\end{DoxyDate}


\doxysubsection{Function Documentation}
\Hypertarget{l2cap_8h_a3c8cff668e194b72f1bf772fdd26895d}\index{l2cap.h@{l2cap.h}!l2cap\_close@{l2cap\_close}}
\index{l2cap\_close@{l2cap\_close}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_close()}{l2cap\_close()}}
{\footnotesize\ttfamily \label{l2cap_8h_a3c8cff668e194b72f1bf772fdd26895d} 
void l2cap\+\_\+close (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Closes out of L2\+CAP. 

Must come after l2cap\+\_\+signal\+\_\+close and the HCI is closed. Will wait for the task to exit. \Hypertarget{l2cap_8h_a6f48dd9f6644b829f23cae02cefad73d}\index{l2cap.h@{l2cap.h}!l2cap\_close\_channel@{l2cap\_close\_channel}}
\index{l2cap\_close\_channel@{l2cap\_close\_channel}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_close\_channel()}{l2cap\_close\_channel()}}
{\footnotesize\ttfamily \label{l2cap_8h_a6f48dd9f6644b829f23cae02cefad73d} 
void l2cap\+\_\+close\+\_\+channel (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{channel}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Closes a L2\+CAP Channel. 

Closes a channel and frees its resources.

This will automatically be done for any remaining open channels when calling l2cap\+\_\+close\+\_\+device.


\begin{DoxyParams}{Parameters}
{\em channel} & Channel to close. \\
\hline
\end{DoxyParams}
\Hypertarget{l2cap_8h_ad4c40ef4c55b21acb04949a4c6c062dd}\index{l2cap.h@{l2cap.h}!l2cap\_close\_device@{l2cap\_close\_device}}
\index{l2cap\_close\_device@{l2cap\_close\_device}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_close\_device()}{l2cap\_close\_device()}}
{\footnotesize\ttfamily \label{l2cap_8h_ad4c40ef4c55b21acb04949a4c6c062dd} 
void l2cap\+\_\+close\+\_\+device (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structl2cap__device__t}{l2cap\+\_\+device\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{device\+\_\+handle}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Closes a L2\+CAP Connection. 

Frees a L2\+CAP device and closes and frees all associated open channels.


\begin{DoxyParams}{Parameters}
{\em device\+\_\+handle} & L2\+CAP device to close \\
\hline
\end{DoxyParams}
\Hypertarget{l2cap_8h_a52ee42d4666663b934669a00485c1360}\index{l2cap.h@{l2cap.h}!l2cap\_initialize@{l2cap\_initialize}}
\index{l2cap\_initialize@{l2cap\_initialize}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_initialize()}{l2cap\_initialize()}}
{\footnotesize\ttfamily \label{l2cap_8h_a52ee42d4666663b934669a00485c1360} 
int l2cap\+\_\+initialize (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Initalized L2\+CAP. 

Its recommended this is called after hci\+\_\+initialize but before working with any bluetooth devices.

This allows you to use L2\+CAP once a connection has been established.

\begin{DoxyReturn}{Returns}
Negative if Error 
\end{DoxyReturn}
\Hypertarget{l2cap_8h_ad1afe37de6799a07366fe423faeab045}\index{l2cap.h@{l2cap.h}!l2cap\_open\_channel@{l2cap\_open\_channel}}
\index{l2cap\_open\_channel@{l2cap\_open\_channel}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_open\_channel()}{l2cap\_open\_channel()}}
{\footnotesize\ttfamily \label{l2cap_8h_ad1afe37de6799a07366fe423faeab045} 
int l2cap\+\_\+open\+\_\+channel (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structl2cap__device__t}{l2cap\+\_\+device\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{device\+\_\+handle}{, }\item[{\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{channel}{, }\item[{uint16\+\_\+t}]{protocol\+\_\+id}{, }\item[{uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{rx\+\_\+buffer}{, }\item[{int}]{rx\+\_\+buffer\+\_\+size}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Opens a L2\+CAP Channel. 

Once a device is open, channels can be opened and closed. Channels are much like sockets, and each one has its own protocol.

By default, the signal channel is already open and used by L2\+CAP.


\begin{DoxyParams}{Parameters}
{\em device\+\_\+handle} & L2\+CAP device to open the channel on \\
\hline
{\em channel} & Channel data structure to write into \\
\hline
{\em protocol\+\_\+id} & Protocol of the channel. Like the socket. \\
\hline
{\em rx\+\_\+buffer} & The receiving buffer for the channel. \\
\hline
{\em rx\+\_\+buffer\+\_\+size} & Size of the receiving buffer. Must be a power of 2.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Negative if Error. 
\end{DoxyReturn}
\Hypertarget{l2cap_8h_a0a485db9568ba82e42f1adffe8d37bab}\index{l2cap.h@{l2cap.h}!l2cap\_open\_device@{l2cap\_open\_device}}
\index{l2cap\_open\_device@{l2cap\_open\_device}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_open\_device()}{l2cap\_open\_device()}}
{\footnotesize\ttfamily \label{l2cap_8h_a0a485db9568ba82e42f1adffe8d37bab} 
int l2cap\+\_\+open\+\_\+device (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structl2cap__device__t}{l2cap\+\_\+device\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{device\+\_\+handle}{, }\item[{uint16\+\_\+t}]{hci\+\_\+device\+\_\+handle}{, }\item[{const uint8\+\_\+t \texorpdfstring{$\ast$}{*}}]{mac\+\_\+address}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Opens a L2\+CAP Connections. 

Sets up L2\+CAP to communicate with a device. This sets up the default signal channel L2\+CAP uses, and adds the device to L2\+CAPS list of active devices.


\begin{DoxyParams}{Parameters}
{\em device\+\_\+handle} & L2\+CAP Device Handle To Create \\
\hline
{\em hci\+\_\+device\+\_\+handle} & Device handle created by hci\+\_\+create\+\_\+connection \\
\hline
{\em mac\+\_\+address} & MAC address of the device. Used to prevent duplicate connections.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Negative if Error. 
\end{DoxyReturn}
\Hypertarget{l2cap_8h_a8d95274e8365de6adde2b5e305feb540}\index{l2cap.h@{l2cap.h}!l2cap\_receive\_channel@{l2cap\_receive\_channel}}
\index{l2cap\_receive\_channel@{l2cap\_receive\_channel}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_receive\_channel()}{l2cap\_receive\_channel()}}
{\footnotesize\ttfamily \label{l2cap_8h_a8d95274e8365de6adde2b5e305feb540} 
int l2cap\+\_\+receive\+\_\+channel (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{channel}{, }\item[{void \texorpdfstring{$\ast$}{*}}]{data}{, }\item[{uint16\+\_\+t}]{size}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Receives from a L2\+CAP Channel. 

Receives data from the internal buffer specified when creating the channel.

The buffer is treated as a FIFO and can hold multiple packets. In the event of an overflow, packet truncation and packet drops are logged and this will just return truncated or 0 byte packets.

Packets should never be truly lost, just that you will have saved up a bunch of 0 byte packets.

Will error on incomplete FIFO fragments.


\begin{DoxyParams}{Parameters}
{\em channel} & Channel to talk to \\
\hline
{\em data} & Data Buffer \\
\hline
{\em size} & Size of buffer. Up to 65535.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Total bytes read (even if they did not fit into buffer). Negative if error. 
\end{DoxyReturn}
\Hypertarget{l2cap_8h_a5bf23efd5d1b3891cebdadf972f89bb7}\index{l2cap.h@{l2cap.h}!l2cap\_send\_channel@{l2cap\_send\_channel}}
\index{l2cap\_send\_channel@{l2cap\_send\_channel}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_send\_channel()}{l2cap\_send\_channel()}}
{\footnotesize\ttfamily \label{l2cap_8h_a5bf23efd5d1b3891cebdadf972f89bb7} 
int l2cap\+\_\+send\+\_\+channel (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{channel}{, }\item[{const void \texorpdfstring{$\ast$}{*}}]{data}{, }\item[{uint16\+\_\+t}]{size}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Sends data over a L2\+CAP Channel. 

Sends a buffer over a L2\+CAP channel. Channels in L2\+CAP can be thought of as a lot like sockets. One device can run multiple protocols, and we expect to see specific protocols on specific channels.


\begin{DoxyParams}{Parameters}
{\em channel} & Channel to talk to \\
\hline
{\em data} & Data Buffer \\
\hline
{\em size} & Size of data. Up to 65535.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Negative if Error 
\end{DoxyReturn}
\Hypertarget{l2cap_8h_a4a876ed132e8c5ffc77f02842e405eeb}\index{l2cap.h@{l2cap.h}!l2cap\_set\_channel\_receive\_event@{l2cap\_set\_channel\_receive\_event}}
\index{l2cap\_set\_channel\_receive\_event@{l2cap\_set\_channel\_receive\_event}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_set\_channel\_receive\_event()}{l2cap\_set\_channel\_receive\_event()}}
{\footnotesize\ttfamily \label{l2cap_8h_a4a876ed132e8c5ffc77f02842e405eeb} 
void l2cap\+\_\+set\+\_\+channel\+\_\+receive\+\_\+event (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structl2cap__channel__t}{l2cap\+\_\+channel\+\_\+t}} \texorpdfstring{$\ast$}{*}}]{channel}{, }\item[{l2cap\+\_\+channel\+\_\+event\+\_\+t}]{event}{, }\item[{void \texorpdfstring{$\ast$}{*}}]{param}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Sets the L2\+CAP on packet receive event. 

When a packet is received on a channel, this event will be called to receive it if you please.


\begin{DoxyParams}{Parameters}
{\em channel} & Channel to set it in \\
\hline
{\em event} & Event Handler \\
\hline
{\em param} & Parameter passed to event. \\
\hline
\end{DoxyParams}
\Hypertarget{l2cap_8h_a8a81a732f492fd7f73db9c3e28cb1b38}\index{l2cap.h@{l2cap.h}!l2cap\_signal\_close@{l2cap\_signal\_close}}
\index{l2cap\_signal\_close@{l2cap\_signal\_close}!l2cap.h@{l2cap.h}}
\doxysubsubsection{\texorpdfstring{l2cap\_signal\_close()}{l2cap\_signal\_close()}}
{\footnotesize\ttfamily \label{l2cap_8h_a8a81a732f492fd7f73db9c3e28cb1b38} 
void l2cap\+\_\+signal\+\_\+close (\begin{DoxyParamCaption}{}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [extern]}}



Begins closing out of L2\+CAP. 

I don\textquotesingle{}t currently have a good way to cancel the blocking ACL read from it, so this will signal the thread to begin exiting. Once HCI is closed, it will actually exist. 